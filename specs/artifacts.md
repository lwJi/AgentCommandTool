# Artifacts Specification

## Overview

The system produces two categories of artifacts: context files (tracked in repo's agent/ directory) and verification artifacts (stored in ARTIFACT_DIR).

---

## Artifact Locations

| Category | Location | Git Status |
|----------|----------|------------|
| Context files | `agent/` directory in repo | **Gitignored** |
| Verification artifacts | ARTIFACT_DIR (local filesystem) | Outside repo |

---

## Context Files

### Location

```
{repo_root}/
└── agent/
    ├── context_latest.md   (symlink to newest)
    ├── context_001.md
    ├── context_002.md
    └── ...
```

### Git Status

**Gitignored** — context files are local only, not committed to repository.

### Snapshot Triggers

New context snapshot (`context_###.md`) created on **semantic milestones only**:

| Trigger | Creates Snapshot |
|---------|------------------|
| Task start | ✅ Yes |
| REPLAN event | ✅ Yes |
| Task success | ✅ Yes |
| Each Scout query | ❌ No |
| Each verify attempt | ❌ No |
| Each fix iteration | ❌ No |

### Content

Each context file contains **raw Scout output** — exact responses preserved without summarization or distillation.

```markdown
# Context Snapshot 002

## Timestamp
2024-01-15T14:32:00Z

## Milestone
REPLAN - Strategy change after 3 failures

## Scout A Report
{raw JSON payload}

## Scout B Report
{raw JSON payload}

## Editor State
- Current hypothesis: ...
- Files modified: ...
- Verify attempts: 3
```

### Pointer File

`context_latest.md` is a symlink (or copy) pointing to the most recent snapshot.

---

## Verification Artifacts

### Location

```
ARTIFACT_DIR/                    (default: ~/.agent-artifacts/)
├── runs/
│   ├── {run_id_001}/
│   │   ├── manifest.json
│   │   ├── logs/
│   │   │   ├── combined.log
│   │   │   ├── step-01-install.log
│   │   │   ├── step-02-typecheck.log
│   │   │   └── ...
│   │   ├── build/
│   │   │   └── (build outputs)
│   │   └── tmp/
│   │       └── (test temporaries)
│   ├── {run_id_002}/
│   │   └── ...
│   └── ...
└── cache/
    └── (optional build cache)
```

### Run Manifest

Each verification run includes `manifest.json`:

```json
{
  "run_id": "run_20240115_143200_abc123",
  "timestamp_start": "2024-01-15T14:32:00Z",
  "timestamp_end": "2024-01-15T14:35:42Z",
  "commit_sha": "a1b2c3d4e5f6...",
  "status": "FAIL",
  "commands_executed": [
    {
      "name": "install",
      "command": "npm ci --frozen-lockfile",
      "exit_code": 0,
      "duration_ms": 12340
    },
    {
      "name": "test",
      "command": "npm test",
      "exit_code": 1,
      "duration_ms": 45670
    }
  ],
  "platform": {
    "os": "linux",
    "arch": "x64",
    "container_image": "node:20-slim"
  }
}
```

---

## Stuck Reports

### Format

Prose markdown document (matching summary format).

### Content

```markdown
# Stuck Report

## Task
{original task description}

## Constraints
{user-provided constraints}

## Status
Hard stop reached after 12 verification attempts.

## Hypotheses

1. **Root cause theory A**: The authentication module may have...
2. **Root cause theory B**: There could be a race condition in...
3. **Alternative approach**: Consider rewriting the validation...

## Verification History

| Run | Status | Primary Failure |
|-----|--------|-----------------|
| run_001 | FAIL | TypeError in auth.ts:42 |
| run_002 | FAIL | TypeError in auth.ts:42 |
| run_003 | FAIL | Timeout in test suite |
| ... | ... | ... |
| run_012 | FAIL | Import resolution error |

## Artifact References

- run_001: /artifacts/runs/run_001/
- run_002: /artifacts/runs/run_002/
- ...

## Files Modified

- src/auth/login.ts
- src/auth/session.ts
- tests/auth.test.ts
```

### Hypotheses Generation

- Generated by **Editor alone**
- Scouts NOT consulted at stuck point
- Based on accumulated debugging context

---

## Retention Policy

### Automatic Management

**Fully automatic** — no manual pinning or user intervention.

### Limits

| Limit | Value |
|-------|-------|
| Maximum runs | 20 |
| Maximum age | 14 days |

Whichever limit is reached first triggers cleanup.

### Stuck Report Exception

Stuck report artifacts retained **until resolved** — not subject to normal retention limits.

### Cleanup Priority

When limits reached:
1. Delete oldest runs first
2. Preserve stuck-related runs until manually cleared

---

## Audit Trail

### What is Persisted

| Data | Persisted |
|------|-----------|
| Context snapshots | ✅ Yes (gitignored local) |
| Run manifests | ✅ Yes |
| Verification logs | ✅ Yes |
| Stuck reports | ✅ Yes |

### What is NOT Persisted

| Data | Reason |
|------|--------|
| Full LLM conversation logs | Not stored for privacy |
| Scout reasoning chains | Only output preserved |
| Editor internal state | Captured in context snapshots only |

Structured artifacts only — no full conversation history.

---

## Access Patterns

### Editor Access

Editor can:
- Read full verification logs via artifact paths
- Write context snapshots to agent/
- Read previous context snapshots for continuity

### Future Retry Access

When resuming from stuck report:
- Receives stuck report only (not full context history)
- Can access artifact directories via run_id references
- Starts fresh but informed

---

## Directory Initialization

### agent/ Directory

Created automatically on first task:
1. Create `agent/` if not exists
2. Add `agent/` to `.gitignore` if not already present
3. Create first context snapshot

### ARTIFACT_DIR

Created automatically:
1. Create directory structure on first Verifier run
2. Use default path or AGENT_ARTIFACT_DIR environment variable

---

## Cleanup Operations

### Automatic Cleanup

Runs periodically (e.g., on task completion):
1. Count runs in ARTIFACT_DIR
2. If > 20: delete oldest until at 20
3. Check ages: delete any > 14 days old
4. Skip stuck-related runs

### Manual Cleanup

Users can manually delete:
- Individual run directories
- Entire ARTIFACT_DIR (system will recreate)
- agent/ directory (loses context history)
